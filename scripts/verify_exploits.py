import json
import boto3
import urllib3
import logging
import os


http = urllib3.PoolManager()
s3 = boto3.client('s3')
logger = logging.getLogger()
logger.setLevel(logging.INFO)


REGION = os.environ.get('AWS_REGION', 'us-east-2') 

def lambda_handler(event, context):
    """
    Main Entry Point for Red Team Lambda.
    Triggers: GET request to Function URL.
    Params: 
      - ?file=path/to/file.csv (Optional override for test file)
    """
    query = event.get('queryStringParameters') or {}
    test_file = query.get('file', "sensitive_data/mock_pii.csv")

    targets = get_project_buckets()
    full_report = {}

    for bucket in targets:
        full_report[bucket] = run_red_team_simulation(bucket, test_file)

    return {
        "statusCode": 200,
        "headers": {"Content-Type": "application/json"},
        "body": json.dumps(full_report)
    }

def get_project_buckets():
    try:
        all_b = s3.list_buckets()
        return [
            b['Name'] for b in all_b['Buckets'] 
            if "cyb611" in b['Name'] 
            and "state" not in b['Name'] 
            and "log" not in b['Name']
        ]
    except:
        return []

def run_red_team_simulation(bucket_name, file_key):
    public_url = f"https://{bucket_name}.s3.{REGION}.amazonaws.com/{file_key}"
    http_url   = f"http://{bucket_name}.s3.{REGION}.amazonaws.com/{file_key}"
    
    results = {}
    try:
        r = http.request('GET', public_url, timeout=3.0)
        if r.status == 200:
            results["1. Data Exfiltration"] = "SUCCESS (Vulnerable)"
        elif r.status == 403:
            results["1. Data Exfiltration"] = "BLOCKED (Secure)"
        else:
            results["1. Data Exfiltration"] = f"UNKNOWN ({r.status})"
    except:
        results["1. Data Exfiltration"] = "ERROR"

    # 2. ATTACK: INSECURE CORS
    try:
        r = http.request('GET', public_url, headers={'Origin': 'http://evil.com'}, timeout=3.0)
        cors_head = r.headers.get('Access-Control-Allow-Origin')
        if cors_head == '*' or cors_head == 'http://evil.com':
            results["2. CORS Exploitation"] = "SUCCESS (Vulnerable)"
        else:
            results["2. CORS Exploitation"] = "BLOCKED (Secure)"
    except:
        results["2. CORS Exploitation"] = "BLOCKED"

    # 3. ATTACK: SSL STRIPPING (HTTP vs HTTPS)
    try:
        r = http.request('GET', http_url, retries=False, timeout=3.0)
        if r.status == 200:
            results["3. SSL Strip"] = "SUCCESS (Vulnerable)"
        elif r.status in [403, 400, 301, 302]:
            results["3. SSL Strip"] = "BLOCKED (Secure)"
        else:
            results["3. SSL Strip"] = f"UNKNOWN ({r.status})"
    except:
        results["3. SSL Strip"] = "BLOCKED"

    # 4. ATTACK: MISSING ENCRYPTION (Internal Check)
    try:
        head = s3.head_object(Bucket=bucket_name, Key=file_key)
        if 'ServerSideEncryption' not in head:
            results["4. Plain Text Data"] = "SUCCESS (Vulnerable)"
        else:
            results["4. Plain Text Data"] = "BLOCKED (Secure)"
    except:
        results["4. Plain Text Data"] = "BLOCKED (Secure / No Access)"

    # 5. ATTACK: VERSIONING CHECK (Ransomware Sim)
    try:
        ver = s3.get_bucket_versioning(Bucket=bucket_name)
        if ver.get('Status') == 'Enabled':
            results["5. Ransomware Risk"] = "BLOCKED (Secure)"
        else:
            results["5. Ransomware Risk"] = "SUCCESS (Vulnerable)"
    except:
        results["5. Ransomware Risk"] = "UNKNOWN"

    return results